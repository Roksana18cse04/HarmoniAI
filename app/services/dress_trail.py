import requests
import time
import os
from dotenv import load_dotenv
from app.schemas.Image_To_Image import DressTrialImageRequest
from app.services.image_get_prediction import get_prediction

# Load environment variables
load_dotenv(override=True)

API_KEY = os.getenv("EACHLABS_API_KEY")
HEADERS = {
    "X-API-Key": API_KEY,
    "Content-Type": "application/json"
}

def create_prediction_for_dress_trail(category:str,cloth_image_url: str, mask_iamge_url:str,human_image_url: str) -> str:
    response = requests.post(
        "https://api.eachlabs.ai/v1/prediction/",
        headers=HEADERS,
        json={
            "model": "idm-vton",
            "version": "0.0.1",
            "input": {
  "crop": False,
  "seed": 42,
  "steps": 30,
  "category": category,
  "force_dc": False,
  "garm_img": cloth_image_url,
  "mask_img": mask_iamge_url,
  "human_img": human_image_url,
  "mask_only": False,
  "garment_des": "your garment des here"
            },
            "webhook_url": ""
        }
    )
    prediction = response.json()
    
    if prediction["status"] != "success":
        raise Exception(f"Prediction failed: {prediction}")
    
    return prediction["predictionID"]
def dress_trial(image_request: DressTrialImageRequest):
    try:
        # Use the image_url already provided (uploaded to Cloudinary in the route)
        prediction_id = create_prediction_for_dress_trail(image_request.category,image_request.cloth_image_url, image_request.mask_image_url,image_request.human_image_url)
        print(f"Prediction created: {prediction_id}")

        # Get result
        result = get_prediction(prediction_id)
        # print(f"Output URL: {result['output']}")
        # print(f"Processing time: {result['metrics']['predict_time']}s")
        return result["output"]
    except Exception as e:
        print(f"Error: {e}")
        
        
if __name__ == "__main__":
    # Test the function
    image_request = DressTrialImageRequest(
        category="dresses",
        cloth_image_url="data:image/jpeg;base64,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",
        mask_image_url="data:image/jpeg;base64,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",
        human_image_url="https://plus.unsplash.com/premium_photo-1661329937685-e9e4eb06a36a?q=80&w=2070&auto=format&fit=crop&ixlib=rb-4.1.0&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D",
    )
    
    dress_trial(image_request)